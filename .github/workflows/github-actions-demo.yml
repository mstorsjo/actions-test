name: GitHub Actions Demo
on: [push]

jobs:
  linux-autotools:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --enable-example
          make -j$(nproc)

  linux-cmake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build

  macos-autotools:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --enable-example
          make -j$(nproc)

  macos-cmake:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build

  mingw-cross-autotools:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --enable-example --host=x86_64-w64-mingw32
          make -j$(nproc)

  mingw-cross-cmake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ -DCMAKE_CROSSCOMPILING=TRUE -DCMAKE_SYSTEM_NAME=Windows
          cmake --build build

  msys-autotools:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: clang64
          update: true
          install: >-
            git
            mingw-w64-clang-x86_64-toolchain
            make
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --enable-example
          make -j$(nproc)

  msys-cmake:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build

  msvc-cmake:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build

  msvc-cmake-ninja:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build

  msvc-cmake-arm64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES -A ARM64
          cmake --build build
      - uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: |
            build/Release/*.dll
            build/Release/*.exe
          retention-days: 7

  msvc-cmake-arm64-ninja:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release fdk-aac -DBUILD_PROGRAMS=YES -A ARM64
          cmake --build build
      - uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: |
            build/Release/*.dll
            build/Release/*.exe
          retention-days: 7

  llvm-mingw:
    runs-on: ubuntu-latest
    steps:
      - run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20211002/llvm-mingw-20211002-ucrt-ubuntu-18.04-x86_64.tar.xz
          tar -Jxvf llvm-mingw-20211002-ucrt-ubuntu-18.04-x86_64.tar.xz
          rm llvm-mingw-*.tar.xz
          sudo mv llvm-mingw-* /opt/llvm-mingw
          echo /opt/llvm-mingw/bin >> $GITHUB_PATH
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --host=aarch64-w64-mingw32 --enable-example
          make -j$(nproc)

  linux-ffmpeg:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --enable-example --prefix=$(pwd)/../prefix
          make -j$(nproc)
          make -j$(nproc) install
      - name: Checkout FFmpeg
        uses: actions/checkout@v2
        with:
          repository: ffmpeg/ffmpeg
          path: ffmpeg
      - run: |
          cd ffmpeg
          PKG_CONFIG_PATH=$(pwd)/../prefix/lib/pkgconfig ./configure --enable-libfdk-aac --enable-nonfree
          make -j$(nproc)

