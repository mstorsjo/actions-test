name: GitHub Actions Demo
on: [push]

env:
  BUILD_TYPE: Release

jobs:
  fdk-aac-cmake-msys:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        include: [
          { msystem: mingw64, prefix: mingw-w64-x86_64 },
          { msystem: mingw32, prefix: mingw-w64-i686 },
          { msystem: ucrt64, prefix: mingw-w64-ucrt-x86_64 },
          { msystem: clang64, prefix: mingw-w64-clang-x86_64 },
        ]
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{matrix.msystem}}
          update: true
          install: >-
            git
            ${{matrix.prefix}}-toolchain
            ${{matrix.prefix}}-cmake
            ${{matrix.prefix}}-make
            ${{matrix.prefix}}-ninja
      - uses: actions/checkout@v2
      - run: |
          # One has to specify -G to cmake; the default generator is for MSVC
          # project files. Specify either Ninja, "MSYS Makefiles" or "MinGW
          # Makefiles". MSYS Makefiles requires installing the "make" package
          # (and building invokes "make"), MinGW Makefiles requires
          # ${{matrix.prefix}}-make and invokes "mingw32-make".

          # Use relative paths to the source dirs; github.workspace contains
          # paths with backslashes which need to be converted/quoted for
          # the msys shell.

          cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} fdk-aac -DBUILD_PROGRAMS=YES
          cmake --build build --config ${{env.BUILD_TYPE}}

  fdk-aac-llvm-mingw:
    runs-on: ubuntu-latest
    steps:
      - run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20210423/llvm-mingw-20210423-ucrt-ubuntu-18.04-x86_64.tar.xz
          tar -Jxvf llvm-mingw-20210423-ucrt-ubuntu-18.04-x86_64.tar.xz
          rm llvm-mingw-*.tar.xz
          sudo mv llvm-mingw-* /opt/llvm-mingw
          echo /opt/llvm-mingw/bin >> $GITHUB_PATH
      - uses: actions/checkout@v2
      - run: |
          cd fdk-aac
          ./autogen.sh
          ./configure --host=aarch64-w64-mingw32 --enable-example --prefix=/opt/fdk-aac
          make -j$(nproc)
          make install-strip

      - uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: |
            /opt/fdk-aac/bin/*
          retention-days: 7

