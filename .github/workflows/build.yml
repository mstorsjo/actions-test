name: Builds
on:
  push:

jobs:
  # Run llvm-mingw's tests on x86_64 and i686 with the cross-built corresponding
  # toolchains from above.
  test-toolchain:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            unzip
            make
      - name: Unpack toolchain
        run: |
          curl -LO https://martin.st/temp/nightly-good.zip
          unzip -q *.zip
          rm *.zip
          mv llvm-mingw-* /llvm-mingw-good
          curl -LO https://martin.st/temp/lldb-bisect3.zip
          unzip *.zip
          rm *.zip
          mv bin /lldb-bisect
      - uses: actions/checkout@v4
      - name: Run tests
        run: |
          cp /llvm-mingw-good/bin/libc++.dll .
          cp /llvm-mingw-good/bin/libunwind.dll .
          /llvm-mingw-good/bin/g++ test/hello-exception.cpp -o hello-exception-dwarf.exe -g
          /lldb-bisect/lldb -b -s lldb-test-script -- hello-exception-dwarf.exe -noop < /dev/null
