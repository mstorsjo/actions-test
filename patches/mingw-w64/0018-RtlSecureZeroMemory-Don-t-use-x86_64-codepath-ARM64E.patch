From 4f235b297d71f4b414bec2013bdae0882a4c55f5 Mon Sep 17 00:00:00 2001
From: Billy Laws <blaws05@gmail.com>
Date: Thu, 14 Sep 2023 23:29:14 +0100
Subject: [PATCH 18/30] RtlSecureZeroMemory: Don't use x86_64 codepath ARM64EC

---
 mingw-w64-crt/intrincs/RtlSecureZeroMemory.c | 2 +-
 mingw-w64-headers/include/winnt.h            | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/mingw-w64-crt/intrincs/RtlSecureZeroMemory.c b/mingw-w64-crt/intrincs/RtlSecureZeroMemory.c
index 8255a1e23..cad0a143a 100644
--- a/mingw-w64-crt/intrincs/RtlSecureZeroMemory.c
+++ b/mingw-w64-crt/intrincs/RtlSecureZeroMemory.c
@@ -4,7 +4,7 @@
 PVOID WINAPI RtlSecureZeroMemory(PVOID ptr,SIZE_T cnt)
 {
   volatile char *vptr = (volatile char *)ptr;
-#ifdef __x86_64
+#if defined(__x86_64) && !defined(__arm64ec__)
   __stosb ((PBYTE)((DWORD64)vptr),0,cnt);
 #else
   while (cnt != 0)
diff --git a/mingw-w64-headers/include/winnt.h b/mingw-w64-headers/include/winnt.h
index 418322e36..6e11bd03a 100644
--- a/mingw-w64-headers/include/winnt.h
+++ b/mingw-w64-headers/include/winnt.h
@@ -9084,14 +9084,14 @@ typedef DWORD (WINAPI *PRTL_RUN_ONCE_INIT_FN)(PRTL_RUN_ONCE, PVOID, PVOID *);
 #if (!defined (__CRT__NO_INLINE) || defined(_UCRT)) && !defined (__WIDL__)
     __forceinline PVOID RtlSecureZeroMemory(PVOID ptr,SIZE_T cnt) {
       volatile char *vptr =(volatile char *)ptr;
-#ifdef __x86_64
+#if defined(__x86_64) && !defined(__arm64ec__)
       __stosb((PBYTE)((DWORD64)vptr),0,cnt);
 #else
       while(cnt) {
 	*vptr++ = 0;
 	cnt--;
       }
-#endif /* __x86_64 */
+#endif /* defined(__x86_64) && !defined(__arm64ec__) */
       return ptr;
     }
 #else /* intrinsic in kernel32 */
-- 
2.25.1

